// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =================== PENGGUNA & KELENGKAPANNYA ===================

model User {
  id              Int              @id @default(autoincrement())
  email           String           @unique
  name            String
  password        String
  role            UserRole         @default(CUSTOMER)
  createdAt       DateTime         @default(now())

  // Relasi
  addresses       Address[]
  orders          Order[]
  serviceBookings ServiceBooking[]
  reviews         Review[]
  articles        Article[]
}

enum UserRole {
  CUSTOMER
  ADMIN
}

model Address {
  id            Int     @id @default(autoincrement())
  label         String  // Contoh: "Rumah", "Kantor"
  recipientName String
  phoneNumber   String
  fullAddress   String  @db.Text
  isPrimary     Boolean @default(false)

  // Foreign Key ke User (Cascade agar alamat terhapus jika user dihapus)
  userId        Int
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// =================== PRODUK & KATEGORI (Alat & Sayuran) ===================

model ProductCategory {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  products Product[]
}

model Product {
  id          Int             @id @default(autoincrement())
  name        String
  imageUrl    String?
  description String?         @db.Text
  price       Int
  stock       Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Foreign Key ke ProductCategory
  categoryId  Int
  category    ProductCategory @relation(fields: [categoryId], references: [id])
   
  // Relasi (Cascade Delete agar produk bisa dihapus walau sudah ada di order/review)
  orderItems  OrderItem[]
  reviews     Review[]
}

model Review {
  id        Int          @id @default(autoincrement())
  rating    Int          // Rating bintang dari 1 sampai 5
  comment   String?      @db.Text
  status    ReviewStatus @default(PENDING)
  createdAt DateTime     @default(now())
   
  // Foreign Keys
  userId    Int
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId Int
  product   Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

// =================== TRANSAKSI (Pesanan, Jasa, Pembayaran) ===================

model Order {
  id          Int         @id @default(autoincrement())
  userId      Int
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  totalAmount Int
  status      String      @default("PENDING") // PENDING, PROCESSING, SHIPPED, COMPLETED, CANCELLED
  createdAt   DateTime    @default(now())

  // Relasi
  items       OrderItem[]
  payment     Payment?
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  quantity  Int
  price     Int     // Harga produk saat dibeli (snapshot)
   
  // Foreign Keys
  orderId   Int
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// =================== JASA & LAYANAN ===================

model ServiceCategory {
  id       Int       @id @default(autoincrement())
  name     String    @unique 
  services Service[]
}

model Service {
  id          Int             @id @default(autoincrement())
  name        String
  imageUrl    String?         // <-- Sudah ada
  description String?         @db.Text
  price       Int
   
  // Relasi
  categoryId  Int
  category    ServiceCategory @relation(fields: [categoryId], references: [id])
  bookings    ServiceBooking[]
}

model ServiceBooking {
  id            Int      @id @default(autoincrement())
  userId        Int
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  serviceId     Int
  service       Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  scheduledDate DateTime
  status        String   @default("REQUESTED")
  notes         String?
  createdAt     DateTime @default(now())

  payment       Payment?
}

// =================== PEMBAYARAN ===================

model Payment {
  id               Int           @id @default(autoincrement())
  amount           Int
  status           PaymentStatus @default(PENDING)
  method           PaymentMethod
  transactionId    String?       @unique // ID dari Midtrans
  paymentDate      DateTime?
  createdAt        DateTime      @default(now())

  // Foreign Key (Relasi ke Order ATAU Booking)
  orderId          Int?            @unique
  order            Order?          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  serviceBookingId Int?            @unique
  serviceBooking   ServiceBooking? @relation(fields: [serviceBookingId], references: [id], onDelete: Cascade)
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PaymentMethod {
  BANK_TRANSFER
  GOPAY
  OVO
  COD
}

// =================== KONTEN & EDUKASI ===================

model Article {
  id          Int      @id @default(autoincrement())
  title       String   @unique
  content     String   @db.Text
  imageUrl    String?
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())

  // Foreign Key
  authorId    Int
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
}